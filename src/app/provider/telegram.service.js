///////////////////////////////////////////////////////////////////////////////////////////
import TelegramBot from 'node-telegram-bot-api'
import db from '../../db/index.js'
///////////////////////////////////////////////////////////////////////////////////////////
class telegramService {

    //////////////////////////////////////////////////////////////////////////////////////
    constructor() { 

        this.token = process.env.TELEGRAM_TOKEN || ''
        this.bot = new TelegramBot( this.token, { polling: true } )
        
    }
    //////////////////////////////////////////////////////////////////////////////////////
    async sendMessage ( chat_id, msj ){

        const message = await this.bot.sendMessage( chat_id , msj )
        return message.message_id ? true : false 
    }
    //////////////////////////////////////////////////////////////////////////////////////
    async sendPhoto ( chat_id, file,text ){

        const sendFile = await this.bot.sendPhoto( chat_id , file, { caption: text } )
        return sendFile.message_id ? true : false 
    }
    //////////////////////////////////////////////////////////////////////////////////////
    onMessage () {

        this.bot.on('message', ( msg ) => {

            const { chat: { id:chat_id,first_name,last_name }, text } = msg
            const  obj = { chat_id, name: `${first_name} ${last_name}`,text }
            console.log(`Mensaje Entrante: ${ JSON.stringify( obj ) }`)
            db.Message.create( obj )

        })
    }
    //////////////////////////////////////////////////////////////////////////////////////

}
///////////////////////////////////////////////////////////////////////////////////////////
export default new telegramService()
///////////////////////////////////////////////////////////////////////////////////////////





